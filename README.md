# Дополнительная функциональность: Комментарии к событиям

## Описание

Реализована система комментариев к событиям с модерацией. Пользователи могут оставлять комментарии к опубликованным событиям, редактировать и удалять свои комментарии. Администратор управляет модерацией: просматривает, фильтрует, подтверждает/отклоняет и удаляет любые комментарии.

## Сущность

### Таблица `comments`

| Поле         | Тип                        | Описание                                    |
|--------------|----------------------------|---------------------------------------------|
| `id`         | BIGINT (PK, auto)          | Идентификатор комментария                   |
| `text`       | VARCHAR(2000), NOT NULL    | Текст комментария                           |
| `event_id`   | BIGINT, FK → events(id)    | Событие, к которому оставлен комментарий    |
| `author_id`  | BIGINT, FK → users(id)     | Автор комментария                           |
| `created_at` | TIMESTAMP                  | Дата и время создания                       |
| `status`     | VARCHAR(100), NOT NULL     | Статус модерации                            |

При удалении события или пользователя связанные комментарии удаляются автоматически.

### Статусы комментария (`CommentStatus`)

- **PENDING** — на модерации (устанавливается при создании и при редактировании)
- **CONFIRMED** — подтверждён администратором
- **REJECTED** — отклонён администратором

## Интеграция с существующим функционалом

Комментарии встроены в DTO событий: поле `comments` (список `CommentDto`) добавлено в `EventFullDto` и `EventShortDto`. При получении событий (как пользователем, так и администратором, а также через публичный API) комментарии подгружаются автоматически.

---

## Эндпоинты

### Private API — для авторизованных пользователей

Базовый путь: `/users/{userId}/comments`

---

#### `POST /users/{userId}/comments?eventId={eventId}`

Создание комментария к событию.

- **Параметры:** `userId` (path), `eventId` (query)
- **Тело запроса:** `{ "text": "..." }` — от 1 до 2000 символов, не пустое
- **Логика:**
    - Пользователь с `userId` должен существовать, иначе — 404
    - Событие с `eventId` должно существовать **и быть опубликованным** (`PUBLISHED`), иначе — 404
    - Комментарий создаётся со статусом `PENDING`
- **Ответ:** `201 Created`, тело — `CommentDto`

---

#### `PATCH /users/{userId}/comments/{commentId}`

Редактирование своего комментария.

- **Параметры:** `userId` (path), `commentId` (path)
- **Тело запроса:** `{ "text": "..." }` — от 1 до 2000 символов, не пустое
- **Логика:**
    - Комментарий должен существовать, иначе — 404
    - Редактировать может **только автор** комментария. Если `userId` не совпадает с автором — 409
    - После редактирования статус сбрасывается на `PENDING` (повторная модерация)
- **Ответ:** `200 OK`, тело — `CommentDto`

---

#### `DELETE /users/{userId}/comments/{commentId}`

Удаление своего комментария.

- **Параметры:** `userId` (path), `commentId` (path)
- **Логика:**
    - Комментарий должен существовать, иначе — 404
    - Удалить может **только автор** комментария. Если `userId` не совпадает с автором — 409
- **Ответ:** `204 No Content`

---

### Admin API — для администратора

Базовый путь: `/admin/comments`

---

#### `POST /admin/comments/search`

Поиск комментариев с фильтрацией.

- **Тело запроса:**
  ```json
  {
    "text": "searched text",  
    "eventIds": [1, 2, 3],
    "userId": 1,
    "rangeStart": "2026-01-01 20:20:20",
    "rangeEnd": "2026-01-10 20:20:20",
    "statusList": ["CONFIRMED"],
    "from": 2,
    "size": 20
  }
  ```

- **Описание полей тела запроса (все необязательные):**
    - `text` — поиск по тексту (без учёта регистра, вхождение подстроки)
    - `eventIds` — список id событий
    - `userId` — id автора
    - `rangeStart` — начало диапазона даты создания (формат `yyyy-MM-dd HH:mm:ss`)
    - `rangeEnd` — конец диапазона даты создания (формат `yyyy-MM-dd HH:mm:ss`)
    - `statusList` — список статусов (`PENDING`, `CONFIRMED`, `REJECTED`)
    - `from` — отступ (по умолчанию `0`)
    - `size` — размер страницы (по умолчанию `10`)
- **Логика:**
    - `rangeStart` не может быть позже `rangeEnd`, иначе — 400
    - Если фильтры не указаны — возвращаются все комментарии с пагинацией
- **Ответ:** `200 OK`, тело — список `CommentDtoAdmin`

---

#### `GET /admin/comments/{commentId}`

Получение комментария по id.

- **Логика:** если комментарий не найден — 404
- **Ответ:** `200 OK`, тело — `CommentDtoAdmin`

---

#### `PATCH /admin/comments`

Массовое изменение статуса комментариев.

- **Тело запроса:**
  ```json
  {
    "commentIds": [1, 2, 3],
    "status": "CONFIRMED"
  }
  ```
- **Логика:**
    - Допустимые целевые статусы: `CONFIRMED` или `REJECTED`. Иной статус — 409
    - Обновляются все указанные комментарии
- **Ответ:** `200 OK`, тело — список `CommentDtoAdmin` (обновлённые комментарии)

---

#### `DELETE /admin/comments/{commentId}`

Удаление любого комментария администратором.

- **Логика:** удаление без проверки авторства
- **Ответ:** `204 No Content`

---

## DTO

### CommentDto (Private / Public)

```json
{
  "id": 1,
  "created": "2025-01-15T10:30:00",
  "text": "Текст комментария",
  "authorName": "Имя автора",
  "eventId": 5,
  "status": "PENDING"
}
```

### CommentDtoAdmin (Admin)

```json
{
  "id": 1,
  "created": "2025-01-15T10:30:00",
  "text": "Текст комментария",
  "authorId": 3,
  "eventId": 5,
  "status": "CONFIRMED"
}
```

Отличие: в публичном DTO отдаётся имя автора (`authorName`), в админском — id автора (`authorId`).